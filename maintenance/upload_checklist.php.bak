<?php
// include "conn-ceklist.php";

include_once "koneksi.php";
$maintenance = 0;
$target_path = "upload_checklist/";
$response = array();

	date_default_timezone_set("Asia/Jakarta");
	header("Content-type: application/json; charset=utf-8");
		// $file_upload_url = '/u/itjatim/sites/itjatim.com/www/syncsemeru/landing/';
$file_upload_url = 'landing/';
$date = date("Y-m-d H:i:s");
$today = date("Ymd");

if ($maintenance == 0) {
			if (isset($_FILES['ceklist']['name'])) {


				$tmp_count = 0;
				$success_count = 0;
				foreach ($_FILES['ceklist']['name'] as $f => $name) {  
					if ($_FILES['ceklist']['tmp_name'][$tmp_count]==null) {
						break;
					}

					$link = basename($_FILES['ceklist']['name'][$tmp_count]);
					// $link = basename($name['name']);
					$file_upload_url .= $link;

					try {

						//cek apakah file yang sama sudah ada, bila ia maka nama di ganti agar tidak tereplace
						$x=0;
						$check_photo = false;
						foreach(glob('landing/*.*') as $fname){
							$file['file'][$x] = $fname;
							if ($fname == 'landing/'.$_FILES['ceklist']['name'][$tmp_count]) {
								$link = basename($_FILES['ceklist']['name'][$tmp_count]);
								$file_upload_url = 'landing/'.rand(0000,9999).$link;
							}
							$x=$x+1;
						}

						if (!move_uploaded_file($_FILES['ceklist']['tmp_name'][$tmp_count], $file_upload_url)) {
							$response[$tmp_count]['success'] = false;
							$response[$tmp_count]['message'] = 'File tidak dapat upload';
						} else {


							//cek apakah filesudah terupload? bila ia, maka tampilkan filenya..:D
							$x=0;
							$check_photo = false;
							foreach(glob('landing/*.*') as $fname){
								$file['file'][$x] = $fname;

								// if ($fname == 'landing/'.$_FILES['ceklist']['name'][$f]) {
								if ($fname == 'landing/'.$_FILES['ceklist']['name'][$tmp_count]) {
									$check_photo = true;
									
								}
								$x=$x+1;
							}

							if ($check_photo) {
								$success_count = $success_count+1;
								$data['file success'][$tmp_count] = 'landing/'.$_FILES['ceklist']['name'][$tmp_count];
								$data['file failed'][$tmp_count] = null;

								$fname_upload = $_FILES['ceklist']['name'][$tmp_count];
								$uri_upload ='backup/'.$today.'/';
								$send_by_tmp = explode('_',$fname_upload,5);
								$send_by_tmp2 = explode('_',$send_by_tmp[4],-1);
								
								$site_id = $send_by_tmp[1];
								$otp = $send_by_tmp[3];
								$getQuery = mysqli_query($con, "SELECT * FROM sik_site WHERE otp_id = '$otp'");
								$sikrow = $getQuery->fetch_assoc();
								$sik_no = $sikrow['sik_no'];


								$send_by='';
								$xt = 0;
								foreach ($send_by_tmp2 as $key) {

									$send_by .= $key;

									if (@$send_by_tmp2[$xt+1]!=null) {
										$send_by .='_';
									}
									$xt = $xt+1;
								}
								// $send_by = $send_by_tmp2[0];

								$query = mysqli_query($con, "INSERT INTO `log_maintenance` 
											(`username`, `uri`, `fname`, `sik_no`, `site_id`, `otp`, `date`) 
											VALUES 
											('$send_by','$uri_upload','$fname_upload','$sik_no','$site_id','$otp','$date')");

								$response['fname_upload'] = $fname_upload;
								$response['uri_upload'] = $uri_upload;
								// $response['send_by_tmp'] = $send_by_tmp;
								// $response['send_by_tmp2'] = $send_by_tmp2;
								$response['send_by'] = $send_by;

							}else{
								$data['file success'][$tmp_count] = null;
								$data['file failed'][$tmp_count] = 'landing/'.$_FILES['ceklist']['name'][$tmp_count];
							}
						}
					} catch (Exception $e) {
						$response[$tmp_count]['success'] = false;
						$response[$tmp_count]['message'] = $e;
					}
					$tmp_count = $tmp_count +1;
					$file_upload_url = 'landing/';
				}
				if ($success_count == $tmp_count) {
					$response['100% success'] = true;
					$response['file success'] = $data['file success'];
					$response['file failed'] = $data['file failed'];

					$send_by = isset($_POST['username']) ? $_POST['username'] : '';
					$sik_no = isset($_POST['sik_no']) ? $_POST['sik_no'] : '';

					if ($sik_no!=null) {

						// $uri_upload = $url_file_month.'/';
						// $fname_upload = $_FILES['images']['name'][$i];

						$query = mysqli_query($con, "INSERT INTO `log_maintenance` 
											(`username`, `sik_no`) 
											VALUES 
											('$send_by','$sik_no')");

					}
				// $response[$tmp_count]['tmp_count'] = $tmp_count;
				}else{
					$response['100% success'] = false;
					$response['file success'] = $data['file success'];
					$response['file failed'] = $data['file failed'];
				}
			} else {
				$response['success'] = false;
				$response['message'] = 'Tidak Terima file!';
			}

			// $f = $file_upload_url;
			// chown($f, 'ngsemeru');

			die(json_encode($response));
			// die(json_encode($multiUP));
} else if ($maintenance == 1) {
	// echo "Sorry, We are under maintenance";
	$response['success'] = false;
	$response['message'] = 'Sorry, We are under maintenance';
	die(json_encode($response));
}


?>